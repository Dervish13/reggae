#!/bin/sh

CONF_FILE="${1}"
CONF_FILE=${CONF_FILE:="/usr/local/etc/reggae.conf"}
if [ -f "${CONF_FILE}" ]; then
    . "${CONF_FILE}"
fi

TEMP_FILE=`mktemp`
JAIL_NAME=${jname}
JAIL_IP=`echo ${ip4_addr} | cut -f 1 -d '/'`
ACTION=`basename $0 | cut -f 1 -d '.'`
CONSUL=${CONSUL:-"http://127.0.2.1:8500"}
TEMPLATE=${TEMPLATE:-"/usr/local/share/reggae/templates/register.tpl"}

sed \
    -e "s/JAIL_NAME/${JAIL_NAME}/g" \
    -e "s/JAIL_IP/${JAIL_IP}/g" \
    ${TEMPLATE} \
    >${TEMP_FILE}

/usr/local/bin/curl -X PUT "${CONSUL}/v1/catalog/${ACTION}" -d @${TEMP_FILE}
rm -rf ${TEMP_FILE}
